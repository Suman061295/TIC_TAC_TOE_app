pipeline {
    agent any
    environment {
        // The DOCKER_REGISTRY must be replaced with your actual Docker Hub username
        DOCKER_REGISTRY = "suman061295" 
        FRONTEND_IMAGE  = "${env.DOCKER_REGISTRY}/simple-frontend:${env.BUILD_ID}"
        BACKEND_IMAGE   = "${env.DOCKER_REGISTRY}/simple-backend:${env.BUILD_ID}"
        DOCKER_CREDENTIALS_ID = 'DOCKER_CREDS'
    }
    stages {
        stage('Checkout Code') {
            steps {
                // Use the standard checkout step
                checkout scm 
            }
        }
        stage('Build & Tag Images') {
            steps {
                echo "Building Frontend image: ${env.FRONTEND_IMAGE}"
                sh "docker build -t ${env.FRONTEND_IMAGE} -f frontend/Dockerfile ."
                echo "Building Backend image: ${env.BACKEND_IMAGE}"
                sh "docker build -t ${env.BACKEND_IMAGE} -f backend/Dockerfile ."
            }
        }
        stage('Push Docker Images') {
            steps {
                withCredentials([usernamePassword(credentialsId: env.DOCKER_CREDENTIALS_ID, passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                    echo "Logging into Docker Hub..."
                    sh "echo \"$DOCKER_PASSWORD\" | docker login -u \"$DOCKER_USERNAME\" --password-stdin"
                    sh "docker push ${env.FRONTEND_IMAGE}"
                    sh "docker push ${env.BACKEND_IMAGE}"
                    sh "docker logout" 
                }
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "Updating Kubernetes manifests with new image tags..."
                    sh "sed -i 's|image: frontend-placeholder-image|image: ${env.FRONTEND_IMAGE}|g' k8s/frontend-deployment.yaml"
                    sh "sed -i 's|image: backend-placeholder-image|image: ${env.BACKEND_IMAGE}|g' k8s/backend-deployment-service.yaml"
                }
            }
        }
    }
}
