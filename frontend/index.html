<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3-Tier Tic-Tac-Toe</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 50px; background-color: #f4f4f9; }
        .board { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); margin: 20px auto; border: 3px solid #333; }
        .cell { border: 1px solid #999; display: flex; align-items: center; justify-content: center; font-size: 48px; cursor: pointer; user-select: none; background-color: white; }
        .cell:hover { background-color: #e0e0e0; }
        #status { font-size: 20px; font-weight: bold; margin-top: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>3-Tier Tic-Tac-Toe</h1>
    <p>Backend (Flask) handles the game state and logic.</p>

    <div id="status">Loading...</div>
    
    <div class="board" id="game-board">
        </div>
    
    <button onclick="resetGame()">Start New Game</button>

    <script>
        const BOARD_SIZE = 3;
        // Ingress routes this path to the backend service
        const API_BASE = "/api/game"; 

        // --- UI Setup ---
        const boardElement = document.getElementById('game-board');
        const statusElement = document.getElementById('status');

        function createBoard() {
            boardElement.innerHTML = '';
            for (let i = 0; i < BOARD_SIZE * BOARD_SIZE; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = i;
                cell.addEventListener('click', () => makeMove(i));
                boardElement.appendChild(cell);
            }
        }

        function updateBoard(board) {
            const cells = boardElement.children;
            board.forEach((value, index) => {
                cells[index].textContent = value === ' ' ? '' : value;
                // Disable clicked cells
                if (value !== ' ') {
                    cells[index].style.pointerEvents = 'none';
                } else {
                    cells[index].style.pointerEvents = 'auto';
                }
            });
        }

        // --- API Interaction ---
        async function fetchState() {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();
                updateBoard(data.board);
                statusElement.textContent = data.message;
            } catch (error) {
                statusElement.textContent = `Error connecting to Backend: ${error.message}`;
                console.error('Fetch error:', error);
            }
        }

        async function makeMove(index) {
            try {
                const response = await fetch(`${API_BASE}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: index })
                });
                const data = await response.json();
                updateBoard(data.board);
                statusElement.textContent = data.message;

                // Disable board if game is over
                if (data.game_over) {
                    boardElement.style.pointerEvents = 'none';
                }

            } catch (error) {
                statusElement.textContent = `Error making move: ${error.message}`;
            }
        }

        async function resetGame() {
            try {
                const response = await fetch(`${API_BASE}/reset`, { method: 'POST' });
                const data = await response.json();
                createBoard(); // Recreate board to reset event listeners
                updateBoard(data.board);
                statusElement.textContent = data.message;
                boardElement.style.pointerEvents = 'auto'; // Re-enable clicks
            } catch (error) {
                statusElement.textContent = `Error resetting game: ${error.message}`;
            }
        }

        // Initialize the game
        createBoard();
        resetGame(); // Fetches initial state
    </script>
</body>
</html>